{% extends "base.html" %}
{% block title %}{{ og_title }}{% endblock %}
{% block meta_description %}{{ meta_description }}{% endblock %}
{% block meta_keywords %}{{ meta_keywords }}{% endblock %}
{% block og_description %}{{ og_description }}{% endblock %}
{% block og_image %}{{ og_image }}{% endblock %}

{% block content %}
{% load static %}
<!-- BEGIN subnav -->
<section class="md:hidden fixed top-[3.5rem] bg-white border-b-[1px] border-gray-300 flex w-full h-[3rem] justify-between items-center">
  <div class="w-[4rem] h-full">
  {% if category_chain|length > 1 %}
      {% with subcat=category_chain|last %}
      <a href="{% url 'catalog-by-slug' subcat.slug %}" class="py-2 pl-2 text-black w-full h-full flex items-center" type="button">
        <svg class="h-8" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-slot="icon">
          <path fill-rule="evenodd" d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
        </svg>
      </a>
      {% endwith %}
      {% elif category_chain %}
            {% with cat=category_chain.0 %}
          <a href="{% url 'catalog-by-slug' cat.slug %}" class="py-2 pl-2 text-black w-full h-full flex items-center" type="button">
            <svg class="h-8" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-slot="icon">
              <path fill-rule="evenodd" d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
            </svg>
          </a>
            {% endwith %}
      {% else %}
        <a href="{% url 'catalog' %}" class="py-2 pl-2 text-black w-full h-full flex items-center" type="button">
          <svg class="h-8" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-slot="icon">
            <path fill-rule="evenodd" d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
          </svg>
        </a>
  {% endif %}
  </div>
  <div class="flex justify-center items-center">
    <h1 class="text-md font-medium">{{ product.title }}</h1>
  </div>
  <div class="w-[4rem] h-full">

  </div>
</section>
<!-- END subnav -->
<section class="container-full lg:gap-8 xl:gap-0 pb-[3rem] pt-[7.5rem] md:pt-[5.5rem]">
  <div class="col-span-full lg:col-span-6 flex items-center justify-center overflow-hidden border-[1px] border-gray-300 aspect-[100/85]">
    {% if product.images.first %}
        <img src="{{ product.images.first.image.url }}" alt="{{ product.title }}" loading="lazy" title="{{ product.title }}" class="w-100" >
    {% endif %}
  </div>
  <div class="col-span-full lg:col-span-6 lg:col-start-7 xl:col-start-8 xl:col-span-5">
    <ul class="hidden col-span-full lg:flex flex-row items-center gap-2 text-sm font-medium">
      <li>
        <a href="{% url 'catalog' %}" class="flex items-center gap-2 text-gray-500 hover:text-pink-600">
          <span>Категории</span>
          <svg class="size-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-slot="icon">
            <path fill-rule="evenodd" d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
          </svg>
        </a>
      </li>
      {% for cat in category_chain %}
        <li>
          <a href="{% url 'catalog-by-slug' cat.slug %}" class="flex items-center gap-2 text-gray-500 hover:text-blue-600">
            <span>{{ cat.title }}</span>
            <svg class="size-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-slot="icon">
              <path fill-rule="evenodd" d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
            </svg>
          </a>
        </li>
      {% endfor %}
      <li>
        <span class="font-[500] text-black">{{ product.title }}</span>
      </li>
    </ul>
    <div class="flex flex-col gap-2 pt-[3rem]">
      <h1 class="font-bold text-4xl">{{ product.title }}</h1>
      <h4 class="text-sm font-medium text-gray-500">Артикул: <span>212456</span></h4>
    </div>
    <ul class="pt-[2rem]">

      {% if sizes.height or sizes.width or sizes.length %}
      <li class="flex items-center gap-2 [ border-b-[1px] border-gray-300] ] [ py-3 ]">
        <span class="w-[60%] inline-block [ font-medium text-gray-500 ]">Размер</span>
          <span class="w-[40%] inline-block [ font-medium text-black ]">
            {{ sizes.height|default:"—" }} ×
            {{ sizes.width|default:"—" }} ×
            {{ sizes.length|default:"—" }} мм
          </span>
      </li>
      {% endif %}

      <li class="flex items-center gap-2 [ border-b-[1px] border-gray-300] ] [ py-3 ]">
        <span class="w-[60%] inline-block [ font-medium text-gray-500 ]">Категория</span>
          <span class="w-[40%] inline-block [ font-medium text-black ]">{{ product.category.title }}</span>
      </li>

      {% if other_attributes %}
      {% for attr in other_attributes %}
      <li class="flex items-center gap-2 [ border-b-[1px] border-gray-300] ] [ py-3 ]">
        <span class="w-[60%] inline-block [ font-medium text-gray-500 ]">{{ attr.name }}</span>
        <span class="w-[40%] inline-block [ font-medium text-black ]">{{ attr.value }}</span>
      </li>
      {% endfor %}
      {% endif %}

    </ul>
    <div class="pt-[3rem]">
      <h5 class="text-2xl font-bold text-pink-500">
        <span class="price">{{ product.price|floatformat:0 }}</span> ₸
      </h5>
    </div>
  </div>
</section>

<div class="px-4  border-t-[1px] border-gray-300">
  <section id="home-hero" class="flex w-full h-[100vh] min-h-[35rem] max-h-[45rem] p-4 pb-[4rem] gap-4 [ overflow-x-auto scroll-smooth snap-x snap-mandatory no-scrollbar ]" x-data="product" x-show="related.length" x-cloak>
    <template x-for="(p, i) in related" :key="p.id">
      <article class="flex-shrink-0 snap-start w-full md:w-1/3 lg:w-1/4 h-full relative overflow-hidden transition-all duration-300 md:block">
      <a class="cursor-none" :href="`/product/${p.slug}/`">
        <figure>
          <img :src="p.images[0].preview_url" loading="lazy" :alt="p.title" :title="p.title">
          <figcaption class="py-3 flex gap-1 flex-col">
            <div class="flex items-center justify-between">
              <h2 class="[ flex flex-col gap-1 ]">
                <span class="text-sm uppercase font-bold" x-text="p.title"></span>
              </h2>
              <p class="font-medium text-sm text-gray-500"></p>
            </div>
            <p class="text-sm text-gray-500 font-medium flex gap-2 ]">
              <span x-text="formatPrice(p.price)"></span>
            </p>
          </figcaption>
        </figure>
      </a>
      </article>
    </template>
    <div id="drag-cursor" class="pointer-events-none fixed z-50 hidden"></div>
  </section>
</div>

<!-- BEGIN drag and scroll -->
<script>
    const slider = document.getElementById('home-hero');
    const cursor = document.getElementById('drag-cursor');

    let isDragging = false;
    let startX, scrollLeft;
    let dragStarted = false;

    // Начало drag (добавлен preventDefault)
    slider.addEventListener('mousedown', (e) => {
        isDragging = true;
        dragStarted = false;
        startX = e.pageX;
        scrollLeft = slider.scrollLeft;
        slider.classList.add('select-none');
        cursor.classList.add('dragging');
        e.preventDefault(); // предотвращает захват ссылок браузером!
    });

    // Drag-логика
    slider.addEventListener('mousemove', (e) => {
        cursor.style.left = e.clientX + 'px';
        cursor.style.top = e.clientY + 'px';

        if (!isDragging) return;
        const x = e.pageX;
        const walk = (x - startX) * 1.5; // скорость скролла
        if (Math.abs(x - startX) > 5) dragStarted = true;
        slider.scrollLeft = scrollLeft - walk;
    });

    // Конец drag
    window.addEventListener('mouseup', () => {
        isDragging = false;
        slider.classList.remove('select-none');
        cursor.classList.remove('dragging');
    });

    // Отмена клика по ссылке, если был drag
    slider.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', (e) => {
            if (dragStarted) {
                e.preventDefault();
            }
        });
    });

    // Показать кастомный курсор
    slider.addEventListener('mouseenter', () => {
        cursor.classList.remove('hidden');
        slider.style.cursor = 'none';
    });
    slider.addEventListener('mouseleave', () => {
        cursor.classList.add('hidden');
        slider.style.cursor = '';
    });

</script>
<!-- END drag and scroll -->

{% endblock %}